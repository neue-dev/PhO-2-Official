<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>(PhO)&#178;</title>

    <link href="./utils/css/main" rel="stylesheet">
    <link href="./utils/css/responsive" rel="stylesheet">

    <!-- Overrides -->
    <style type="text/css">
      html, body, .container, .card {
        padding: 2em;
        letter-spacing: -0.025em;
      }

      span {
        white-space: nowrap;
      }      

      .header {
        letter-spacing: -0.06em;
      }
    </style>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Semantic -->
    <link href="./resources/semantic/semantic.css" rel="stylesheet">
    <script src="./resources/semantic/semantic.js"></script>
    
    <!-- Pho2 Utils -->
    <script src="/x"></script>
    <script src="/dom"></script>
    <script src="/pho2"></script>
  </head>

  <body>
    <div class="container">
      <div class="ui content">
        <span class=" ui header huge text">
          Progress
        </span>
				<br><br>
				<div class="ui breadcrumb">
					<a class="section" href="/dashboard">Dashboard</a>
					<i class="right arrow icon divider"></i>
					<div class="active section">Progress</div>
				</div>
      </div>
      <br><br>

      <div class="ui basic cards">
        <div class="ui vertical menu" style="margin: 0 2rem 2rem 0;">
          <div class="item">
            <div class="ui transparent icon input">
              <input class="search-bar" type="text" placeholder="Search current table...">
              <i class="search icon"></i>
            </div>
          </div>
          <div class="tabs-menu">
            <a class="item active" href="problems">
              Problems
              <div class="ui label problems-label">0</div>
            </a>
            <a class="item" href="submissions">
              Submisions
              <div class="ui label submissions-label">0</div>
            </a>
          </div>
          <div class="card">
            <img class="ui centered medium image" width="200" src="/pho-2-icon-dark">
          </div>
        </div>  
        <div class="tabs">
          <div class="ui tab segment problems active" style="margin-top: 0;" data-tab="problems">
            <table class="ui single line table problems-table">
  
            </table>
          </div>
          <div class="ui tab segment submissions" style="margin-top: 0;" data-tab="submissions">
            <table class="ui single line table submissions-table">
  
            </table>      
          </div>
        </div>
      </div>
    </div>

    <div class="ui modal problems-modal"></div>
    <div class="ui modal submissions-modal"></div>
    <div class="ui modal submit-modal"></div>

    <script>
      
			// Search bar
      const search_bar = DOM.select('.search-bar')
      
			// Keybinds 
      DOM.keybind({ ctrlKey: true, keyCode: 'f' }, () => search_bar.focus())
      
      // Filter feature
      search_bar.listen('input', (e) => {

        // Grab the table
        const tab_name = tabs.tabs_active_tab();
        const tab = tabs.select(tab_name);
        const table = tab.select('table')
        const value = e.target.value.toUpperCase();

        // Filter it
        table.table_filter((data, text) =>  
          text
            .toUpperCase()
            .includes(value))

        // Re-render it
        table.table_map(table.mapper);
      });

			// Tabs handling
			const tabs = DOM.select('.tabs');
			const tabs_menu = DOM.select('.tabs-menu');
			
			DOM.stateful_tabs('progress-tabs', tabs)
			DOM.stateful_menu('progress-menu', tabs_menu)

			tabs_menu.menu_on_selected(c => tabs.tabs_active_tab(c))
			tabs_menu.menu_selected_item('.problems');

			// Tables, labels and, modals
			const problems_label = DOM.select('.problems-label');
			const problems_table = DOM.stateful_table('problems-table', DOM.select('.problems-table'));
			const problems_modal = DOM.stateful_modal('problems-modal', DOM.select('.problems-modal'))
			
			const submissions_label = DOM.select('.submissions-label');
			const submissions_table = DOM.stateful_table('submissions-table', DOM.select('.submissions-table'));
			const submissions_modal = DOM.stateful_modal('submissions-modal', DOM.select('.submissions-modal'))
			
			// Set up the modals
			problems_modal.modal_header('View Problem Details');
			submissions_modal.modal_header('View Submission Details');

			submissions_table.mapper = (data) => DOM.div().t(data);
			problems_table.mapper = (data) => DOM.div().t(data);

      // Save the submissions
      X.request('./user/submissionlist', 'POST')
        .then(({ submissions }) => PHO2.submissions(submissions))
        .then(() => submissions_label.t(PHO2.submissions().length))
        .then(() => submissions_table.table_data(PHO2.submissions()))
        .then(() => submissions_table.table_map(submissions_table.mapper))

      // Save the problems
      X.request('./user/problemlist', 'POST')
        .then(({ problems }) => PHO2.problems(problems))
        .then(() => problems_label.t(PHO2.problems().length))
        .then(() => problems_table.table_data(PHO2.problems()))
        .then(() => problems_table.table_map(problems_table.mapper))

    </script>

    <!-- Trademark -->
    <script src="/trademark"></script>  
  </body>
</html>