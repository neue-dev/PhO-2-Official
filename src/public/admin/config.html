<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>(PhO)&#178;</title>

    <link href="./utils/css/main" rel="stylesheet">
    <link href="./utils/css/responsive" rel="stylesheet">

    <!-- Overrides -->
    <style type="text/css">
      html, body, .container, .card {
        padding: 2em;
        letter-spacing: -0.025em;
      }

      span {
        white-space: nowrap;
      }      

      .header {
        letter-spacing: -0.06em;
      }
    </style>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Semantic -->
    <link href="./resources/semantic/semantic.css" rel="stylesheet">
    <script src="./resources/semantic/semantic.js"></script>
    
    <!-- Pho2 Utils -->
    <script src="/x"></script>
    <script src="/dom"></script>
    <script src="/pho2"></script>
  </head>

  <body>
    <div class="container">
      <div class="ui content">
        <span class=" ui header huge text">
          Config
        </span>
				<br><br>
				<div class="ui breadcrumb">
					<a class="section" href="/dashboard">Dashboard</a>
					<i class="right arrow icon divider"></i>
					<div class="active section">Config</div>
				</div>
      </div>
      <br><br>

      <div class="ui basic cards">
        <div class="ui vertical menu" style="margin: 0 2rem 2rem 0;">
          <div class="item">
            <div class="ui transparent icon input">
              <input class="search-bar" type="text" placeholder="Search current table...">
              <i class="search icon"></i>
            </div>
          </div>
          <div class="tabs-menu">
            <a class="item active" href="config">
              Contest Parameters
              <div class="ui label config-label">0</div>
            </a>
            <a class="item" href="users">
              Users
              <div class="ui label users-label">0</div>
            </a>
            <a class="item" href="problems">
              Problems
              <div class="ui label problems-label">0</div>
            </a>
          </div>
          <div class="card">
            <img class="ui centered medium image" width="200" src="/pho-2-icon-dark">
          </div>
        </div>  
        <div class="tabs">
          <div class="ui tab segment config active" style="margin-top: 0;" data-tab="config">
            <table class="ui single line table config-table">
  
            </table>
          </div>
          <div class="ui tab segment users" style="margin-top: 0;" data-tab="users">
            <table class="ui single line table users-table">
  
            </table>      
          </div>
          <div class="ui tab segment problems" style="margin-top: 0;" data-tab="problems">
            <table class="ui single line table problems-table">
  
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="ui modal config-modal"></div>
    <div class="ui modal users-modal"></div>
    <div class="ui modal problems-modal"></div>

    <script>
      
      // Keybinds 
      DOM.keybind({ ctrlKey: true, keyCode: 'f' }, () => search_bar.focus())
      
      // Grab labels
      const config_label = DOM.select('.config-label');
      const users_label = DOM.select('.users-label');
      const problems_label = DOM.select('.problems-label');

      // Table elements
      const config_table = DOM.stateful_table('config-table', DOM.select('.config-table'));
      const users_table = DOM.stateful_table('users-table', DOM.select('.users-table'));
      const problems_table = DOM.stateful_table('problems-table', DOM.select('.problems-table'));

      // Modals
      const config_modal = DOM.stateful_modal('config-modal', DOM.select('.config-modal'))
      const users_modal = DOM.stateful_modal('users-modal', DOM.select('.users-modal'))
      const problems_modal = DOM.stateful_modal('problems-modal', DOM.select('.problems-modal'))
      
      // Set up the modals
      config_modal.modal_header('Edit Config');
      users_modal.modal_header('Edit User');
      problems_modal.modal_header('Edit Problem');

      // Tab handling
      const tabs = DOM.select('.tabs');
      const tabs_menu = DOM.select('.tabs-menu');

      DOM.stateful_tabs('config-tabs', tabs)
      DOM.stateful_menu('config-menu', tabs_menu)

      tabs_menu.menu_on_selected(c => tabs.tabs_active_tab(c))
      tabs_menu.menu_selected_item('.config');

      // Search bar
      const search_bar = DOM.select('.search-bar')
      
      // Filter feature
      search_bar.listen('input', (e) => {

        // Grab the table
        const tab_name = tabs.tabs_active_tab();
        const tab = tabs.select(tab_name);
        const table = tab.select('table')
        const value = e.target.value.toUpperCase();

        // Filter it
        table.table_filter((data, text) =>  
          text
            .toUpperCase()
            .includes(value))

        // Re-render it
        table.table_map(table.mapper);
      });

      // ! <!-- ! move elsewhere  -->
      const date = (timestamp) => {
        
        const date = new Date(timestamp * 1)
        const date_options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        };

        return `${date.toISOString().substring(11, 16)} 
          ${date.toLocaleDateString(undefined, date_options)}`;
      }
      
      /**
       *  Reusable components and styles
       */

      // Some convenience styles
      const auto_width = { width: 0 };
      const full_width = { width: document.width };

      // Row and data
      const tr = () => DOM.tr();
      const td = () => DOM.td().s(auto_width);

      // Label
      const td_label = () =>
        DOM.td().s(auto_width).append(
          DOM.label())
        
      // Edit button
      const edit_button = () => 
        DOM.td().s(auto_width).c('right', 'aligned').append(
          DOM.buttons().append(DOM.button().t('Edit')))

      // Edit delete button
      const edit_delete_button = () => 
        DOM.td().s(auto_width).c('right', 'aligned').append(
          DOM.buttons().append(
            DOM.button().t('Edit'),
            DOM.or(),
            DOM.button().t('Delete').c('negative')))

      // Config table mapper
      const config_table_mapper = (parameter) => (
        tr().append(
          td_label().select(0).t(parameter.key).parent(),
          td().append(
            parameter.type == 'url'
              ? DOM.link().t(parameter.value).ref(parameter.value) : parameter.type == 'date'
              ? DOM.span().t(date(parameter.value)) : parameter.type == 'duration'
              ? DOM.span().t(parameter.value) 
              : DOM.span().t(parameter.value)),
          edit_button()
            .listen('click', (e) => config_modal.modal_open()))
      )

      // Problem table mapper
      const problems_table_mapper = (problem) => (
        tr().append(
          td_label().select(0).t(problem.code.number + problem.code.alpha).parent(),
          td().t(problem.name),
          td().t(problem.answer.mantissa + ' &times; 10').append(
            DOM.sup().t(problem.answer.exponent)),
          td().t(problem.tolerance),
          edit_delete_button()
            .listen('click', (e) => problems_modal.modal_open()))
      )

      // User table mapper
      const users_table_mapper = (user) => (
        tr().append(
          td().s(auto_width).t(user.username),
          td().s(auto_width).append(
            user.isAdmin 
              ? DOM.label().c('red').t('admin')
              : DOM.label().t(user.category).c(
                user.category == 'junior' 
                  ? 'default'
                  : 'black'
              )),
          td_label().select(0).t(user.status)
            .c(user.status == 'spectating' 
              ? 'blue' : user.status == 'disqualified' 
              ? 'orange'
              : 'default')
            .c(user.status == 'participating' 
              ? 'default' 
              : 'basic').parent(),
          edit_delete_button()
            .listen('click', (e) => users_modal.modal_open()))
      )

      // Set up the tables
      config_table
        .table_header('Parameter', 'Value', '')
        .mapper = config_table_mapper;

      users_table
        .table_header('User', 'Category', 'Status', '')
        .mapper = users_table_mapper;

      problems_table
        .table_header('Code', 'Problem', 'Answer', 'Tolerance', '')
        .mapper = problems_table_mapper;

      // Save the config
      X.request('./admin/configlist', 'POST')
        .then(({ config }) => PHO2.config(config))
        .then(() => config_label.t(PHO2.config().length))
        .then(() => config_table.table_data(PHO2.config()))
        .then(() => config_table.table_map(config_table.mapper))

      // Save the users
      X.request('./admin/userlist', 'POST')
        .then(({ users }) => PHO2.users(users))
        .then(() => users_label.t(PHO2.users().length))
        .then(() => users_table.table_data(PHO2.users()))
        .then(() => users_table.table_map(users_table.mapper))

      // Save the problems
      X.request('./admin/problemlist', 'POST')
        .then(({ problems }) => PHO2.problems(problems))
        .then(() => problems_label.t(PHO2.problems().length))
        .then(() => problems_table.table_data(PHO2.problems()))
        .then(() => problems_table.table_map(problems_table.mapper))

    </script>

    <!-- Trademark -->
    <script src="/trademark"></script>  
  </body>
</html>