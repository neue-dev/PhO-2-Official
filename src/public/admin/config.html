<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>(PhO)&#178;</title>

    <link href="./utils/css/responsive" rel="stylesheet">

    <!-- Overrides -->
    <style type="text/css">
      html, body, .container, .card {
        padding: 2em;
        letter-spacing: -0.025em;
      }

      span {
        white-space: nowrap;
      }      

      .header {
        letter-spacing: -0.06em;
      }
    </style>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Semantic -->
    <link href="./resources/semantic/semantic.css" rel="stylesheet">
    <script src="./resources/semantic/semantic.js"></script>
    
    <!-- Pho2 Utils -->
    <script src="/x"></script>
    <script src="/dom"></script>
    <script src="/pho2"></script>
  </head>

  <body>
    <div class="container">
      <div class="ui content">
        <span class=" ui header huge text">
          Config
        </span>
				<br><br>
				<div class="ui breadcrumb">
					<a class="section" href="/dashboard">Dashboard</a>
					<i class="right arrow icon divider"></i>
					<div class="active section">Config</div>
				</div>
      </div>
      <br><br>

      <div class="ui pointing menu">
        <a class="active item">
          Contest Parameters
        </a>
        <a class="item">
          Users
        </a>
        <a class="item">
          Problems
        </a>
        <div class="right menu">
          <div class="item">
            <div class="ui transparent icon input">
              <input type="text" placeholder="Search...">
              <i class="search link icon"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="ui top attached tab segment active" data-tab="one1">
        <table class="ui celled striped table config-table">

        </table>
      </div>
      <div class="ui top attached tab segment" data-tab="two1">
        <table class="ui celled striped table users-table">

        </table>      
      </div>
      <div class="ui top attached tab segment" data-tab="three1">
        <table class="ui single line table problems-table">

        </table>
      </div>
    </div>

    <script>

      // Save the config
      X.request('./admin/configlist', 'POST')
        .then(({ config }) => PHO2.config(config))
        .then(() => config_table())

      // Save the users
      X.request('./admin/userlist', 'POST')
        .then(({ users }) => PHO2.users(users))
        .then(() => users_table())

      // Save the problems
      X.request('./admin/problemlist', 'POST')
        .then(({ problems }) => PHO2.problems(problems))
        .then(() => problems_table())
        

      
      const date = (timestamp) => {
        
        const date = new Date(timestamp * 1)
        const date_options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        };

        return `${date.toISOString().substring(11, 16)} 
          ${date.toLocaleDateString(undefined, date_options)}`;
      }

      function problems_table() {

        // Data
        const problems = PHO2.problems();

        // Table
        const table = DOM.select('.problems-table');
        const thead = DOM.thead();
        const tbody = DOM.tbody();

        table.s({ border: 'none' });
        table.append(thead, tbody);

        // Header
        const header = DOM.tr()
          .append(
            DOM.th().t('Problem').a('colspan', 2),
            DOM.th().t('Answer'),
            DOM.th().t('Tolerance'),
            DOM.th().t(''),
            DOM.th().t(''))
        thead.append(header)
        
        // Rows
        for(problem of problems) {
          const code = problem.code.number + problem.code.alpha;
          const auto_width = { width: 0 };
          const full_width = { width: document.width };

          const row = 
            DOM.tr().append(

              // Problem code
              DOM.td().s(auto_width).append(
                DOM.label().t(code)),

              // Name
              DOM.td().s(auto_width).t(problem.name),

              // Answer
              DOM.td().s(auto_width).t(problem.answer.mantissa + ' &times; 10').append(
                DOM.sup().t(problem.answer.exponent)
              ),

              // Tolerance
              DOM.td().s(auto_width).t(problem.tolerance),

              // Edit button
              DOM.td().s(auto_width).c('right', 'aligned').append(
                DOM.buttons().append(
                  DOM.button().t('Edit'),
                  DOM.or(),
                  DOM.button().t('Delete').c('negative'))))

          tbody.append(row)
        }
      }

      function users_table() {

        // Data
        const users = PHO2.users();

        // Table
        const table = DOM.select('.users-table');
        const thead = DOM.thead();
        const tbody = DOM.tbody();

        table.s({ border: 'none' });
        table.append(thead, tbody);

        // Header
        const header = DOM.tr()
          .append(
            DOM.th().t('User'),
            DOM.th().t('Category'),
            DOM.th().t('Status'),
            DOM.th().t(''),
            DOM.th().t(''))
        thead.append(header)

        // Rows
        for(user of users) {

          const auto_width = { width: 0 };
          const full_width = { width: document.width };
          const row = 
            DOM.tr().append(

              // Name
              DOM.td().s(auto_width).t(user.username),

              // Category / admin
              DOM.td().s(auto_width).append(
                user.isAdmin 
                  ? DOM.label().c('red').t('admin')
                  : DOM.label().t(user.category).c(
                    user.category == 'junior' 
                      ? 'default'
                      : 'black'
                  )),

              // Status
              DOM.td().s(auto_width).append(
                DOM.label().t(user.status)
                  .c(user.status == 'spectating' 
                    ? 'blue' : user.status == 'disqualified' 
                    ? 'orange'
                    : 'default')
                  .c(user.status == 'participating' 
                    ? 'default' 
                    : 'basic')),

              // Edit button
              DOM.td().s(auto_width).c('right', 'aligned').append(
                DOM.buttons().append(
                  DOM.button().t('Edit'),
                  DOM.or(),
                  DOM.button().t('Delete').c('negative'))))

          tbody.append(row)
        }
      }      

      function config_table() {

        // Data
        const config = PHO2.config();

        // Table
        const table = DOM.select('.config-table');
        const thead = DOM.thead();
        const tbody = DOM.tbody();

        table.s({ border: 'none' });
        table.append(thead, tbody);

        // Header
        const header = DOM.tr()
          .append(
            DOM.th().t('Parameter'),
            DOM.th().t('Value'),
            DOM.th().t(''),
            DOM.th().t(''))
        thead.append(header)

        // Rows
        for(parameter of config) {

          console.log(parameter)

          const auto_width = { width: 0 };
          const full_width = { width: document.width };
          const row = 
            DOM.tr().append(

              // Name
              DOM.td().s(auto_width).t(parameter.key),

              // Value
              DOM.td().s(auto_width).append(
                parameter.type == 'url'
                  ? DOM.link().t(parameter.value).ref(parameter.value) : parameter.type == 'date'
                  ? DOM.span().t(date(parameter.value)) : parameter.type == 'duration'
                  ? DOM.span().t(parameter.value) 
                  : DOM.span().t(parameter.value) 
              ),

              // Edit button
              DOM.td().s(auto_width).c('right', 'aligned').append(
                DOM.buttons().append(
                  DOM.button().t('Edit'),
                  DOM.or(),
                  DOM.button().t('Delete').c('negative'))))

          tbody.append(row)
        }
      }
    </script>
  </body>
</html>